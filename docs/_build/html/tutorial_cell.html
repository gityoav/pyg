
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tutorial: pyg.base.cell &#8212; pyg 0.0.1 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="tutorial: pyg.timeseries" href="tutorial_timeseries.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="tutorial-pyg-base-cell">
<h1>tutorial: pyg.base.cell<a class="headerlink" href="#tutorial-pyg-base-cell" title="Permalink to this headline">¶</a></h1>
<p>Cell is a dict that forms part of a calculation graph. Most usefully,
db_cell is implemented to maintain persistency of the function output in
MongoDB. Before we start, we will show a few examples of how a cell
works. Then, we will build a toy example of trading stocks based on an
exponentially weighted crossover.</p>
<ul class="simple">
<li><p>We will start by creating the system using pyg.base.dictable and pyg.timeseries.</p></li>
<li><p>We then repeat the same code, this time modifying it slightly to save the data and calculation graph in MongoDB while running the calculation.</p></li>
<li><p>We conclude by discussing the two approaches</p></li>
</ul>
<div class="section" id="cell-101">
<h2>Cell 101<a class="headerlink" href="#cell-101" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyg</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span>  <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">cell</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span>  <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="p">)</span>
<span class="n">b</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cell</span>
<span class="n">x</span><span class="p">:</span>
    <span class="mi">2</span>
<span class="n">y</span><span class="p">:</span>
    <span class="n">cell</span>
    <span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">function</span> <span class="o">&lt;</span><span class="k">lambda</span><span class="o">&gt;</span> <span class="n">at</span> <span class="mh">0x000001CBBFDEA1F0</span><span class="o">&gt;</span><span class="p">}</span>
<span class="n">function</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">function</span> <span class="o">&lt;</span><span class="k">lambda</span><span class="o">&gt;</span> <span class="n">at</span> <span class="mh">0x000001CBBFDEA280</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="c1">## b is a dict</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;function&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">.</span><span class="n">_args</span> <span class="c1">## inputs</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="o">.</span><span class="n">_output</span> <span class="c1">## where the output will go once we calculate it</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">b</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="c1">## b has not calculated yet... please run it</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span><span class="p">()</span> <span class="c1"># calculated object</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cell</span>
<span class="n">x</span><span class="p">:</span>
    <span class="mi">2</span>
<span class="n">y</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span>
        <span class="mi">1</span>
    <span class="n">y</span><span class="p">:</span>
        <span class="mi">2</span>
    <span class="n">function</span><span class="p">:</span>
        <span class="o">&lt;</span><span class="n">function</span> <span class="o">&lt;</span><span class="k">lambda</span><span class="o">&gt;</span> <span class="n">at</span> <span class="mh">0x000001CBBFDEA1F0</span><span class="o">&gt;</span>
    <span class="n">data</span><span class="p">:</span>
        <span class="mi">3</span>
<span class="n">function</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">function</span> <span class="o">&lt;</span><span class="k">lambda</span><span class="o">&gt;</span> <span class="n">at</span> <span class="mh">0x000001CBBFDEA280</span><span class="o">&gt;</span>
<span class="n">data</span><span class="p">:</span>
    <span class="mi">6</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="ow">not</span> <span class="n">b</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="c1">## b has calculated now... no need to run it</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cell</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">**</span> <span class="n">y</span><span class="p">)(</span><span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># you can define the cell and then call it with the values</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cell</span>
<span class="n">function</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">function</span> <span class="o">&lt;</span><span class="k">lambda</span><span class="o">&gt;</span> <span class="n">at</span> <span class="mh">0x000001CBBC5B51F0</span><span class="o">&gt;</span>
<span class="n">x</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span>
        <span class="mi">1</span>
    <span class="n">y</span><span class="p">:</span>
        <span class="mi">2</span>
    <span class="n">function</span><span class="p">:</span>
        <span class="o">&lt;</span><span class="n">function</span> <span class="o">&lt;</span><span class="k">lambda</span><span class="o">&gt;</span> <span class="n">at</span> <span class="mh">0x000001CBBFDEA1F0</span><span class="o">&gt;</span>
    <span class="n">data</span><span class="p">:</span>
        <span class="mi">3</span>
<span class="n">y</span><span class="p">:</span>
    <span class="mi">2</span>
<span class="n">data</span><span class="p">:</span>
    <span class="mi">9</span>
</pre></div>
</div>
</div>
<div class="section" id="workflow-without-saving-to-the-database">
<h2>Workflow without saving to the database<a class="headerlink" href="#workflow-without-saving-to-the-database" title="Permalink to this headline">¶</a></h2>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pyg</span> <span class="kn">import</span> <span class="o">*</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span> <span class="c1"># see https://github.com/ranaroussi/yfinance</span>
<span class="n">constituents</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;d:/dropbox/yoav/python/pyg/docs/constituents_csv.csv&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span> <span class="c1"># downloaded from &lt;https://datahub.io/core/s-and-p-500-companies#resource-constituents&gt;</span>
<span class="n">constituents</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dictable</span><span class="p">[</span><span class="mi">505</span> <span class="n">x</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">symbol</span><span class="o">|</span><span class="n">name</span>                  <span class="o">|</span><span class="n">sector</span>
<span class="n">MMM</span>   <span class="o">|</span><span class="mi">3</span><span class="n">M</span> <span class="n">Company</span>            <span class="o">|</span><span class="n">Industrials</span>
<span class="n">AOS</span>   <span class="o">|</span><span class="n">A</span><span class="o">.</span><span class="n">O</span><span class="o">.</span> <span class="n">Smith</span> <span class="n">Corp</span>       <span class="o">|</span><span class="n">Industrials</span>
<span class="n">ABT</span>   <span class="o">|</span><span class="n">Abbott</span> <span class="n">Laboratories</span>   <span class="o">|</span><span class="n">Health</span> <span class="n">Care</span>
<span class="o">...</span><span class="mi">505</span> <span class="n">rows</span><span class="o">...</span>
<span class="n">ZBH</span>   <span class="o">|</span><span class="n">Zimmer</span> <span class="n">Biomet</span> <span class="n">Holdings</span><span class="o">|</span><span class="n">Health</span> <span class="n">Care</span>
<span class="n">ZION</span>  <span class="o">|</span><span class="n">Zions</span> <span class="n">Bancorp</span>         <span class="o">|</span><span class="n">Financials</span>
<span class="n">ZTS</span>   <span class="o">|</span><span class="n">Zoetis</span>                <span class="o">|</span><span class="n">Health</span> <span class="n">Care</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">constituents</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">sector</span> <span class="o">=</span> <span class="s1">&#39;Energy&#39;</span><span class="p">)</span>
<span class="n">stocks</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dictable</span><span class="p">[</span><span class="mi">26</span> <span class="n">x</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">name</span>              <span class="o">|</span><span class="n">sector</span><span class="o">|</span><span class="n">symbol</span>
<span class="n">Apache</span> <span class="n">Corporation</span><span class="o">|</span><span class="n">Energy</span><span class="o">|</span><span class="n">APA</span>
<span class="n">Baker</span> <span class="n">Hughes</span> <span class="n">Co</span>   <span class="o">|</span><span class="n">Energy</span><span class="o">|</span><span class="n">BKR</span>
<span class="n">Cabot</span> <span class="n">Oil</span> <span class="o">&amp;</span> <span class="n">Gas</span>   <span class="o">|</span><span class="n">Energy</span><span class="o">|</span><span class="n">COG</span>
<span class="o">...</span><span class="mi">26</span> <span class="n">rows</span><span class="o">...</span>
<span class="n">TechnipFMC</span>        <span class="o">|</span><span class="n">Energy</span><span class="o">|</span><span class="n">FTI</span>
<span class="n">Valero</span> <span class="n">Energy</span>     <span class="o">|</span><span class="n">Energy</span><span class="o">|</span><span class="n">VLO</span>
<span class="n">Williams</span> <span class="n">Companies</span><span class="o">|</span><span class="n">Energy</span><span class="o">|</span><span class="n">WMB</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">history</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">))</span>
</pre></div>
</div>
<pre class="literal-block">[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed

1 Failed download:
- NBL: No data found, symbol may be delisted
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed
[<strong>*******************100%*********************</strong>]  1 of 1 completed</pre>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="k">lambda</span> <span class="n">history</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">adj</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">history</span><span class="p">:</span> <span class="n">getitem</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">history</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">rtn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">adj</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">adj</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">vol</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rtn</span><span class="p">:</span> <span class="n">ewmstd</span><span class="p">(</span><span class="n">a</span> <span class="o">=</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">30</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_data</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>
<span class="k">def</span> <span class="nf">crossover_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="n">fast</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">slow</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">vol</span> <span class="o">=</span> <span class="p">{})</span> <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">state</span>
    <span class="n">fast_ewma_</span> <span class="o">=</span> <span class="n">ewma_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="o">**</span><span class="n">state</span><span class="o">.</span><span class="n">fast</span><span class="p">)</span>
    <span class="n">slow_ewma_</span> <span class="o">=</span> <span class="n">ewma_</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="o">**</span><span class="n">state</span><span class="o">.</span><span class="n">slow</span><span class="p">)</span>
    <span class="n">raw_signal</span> <span class="o">=</span> <span class="n">fast_ewma_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">slow_ewma_</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">_data</span><span class="p">)</span>
    <span class="n">signal_rms</span> <span class="o">=</span> <span class="n">ewmrms_</span><span class="p">(</span><span class="n">raw_signal</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="o">**</span><span class="n">state</span><span class="o">.</span><span class="n">vol</span><span class="p">)</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="n">raw_signal</span><span class="o">/</span><span class="n">v2na</span><span class="p">(</span><span class="n">signal_rms</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">_data</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Dict</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">normalized</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">(</span><span class="n">fast</span> <span class="o">=</span> <span class="n">fast_ewma_</span><span class="p">,</span> <span class="n">slow</span> <span class="o">=</span> <span class="n">slow_ewma_</span><span class="p">,</span> <span class="n">vol</span> <span class="o">=</span> <span class="n">signal_rms</span><span class="p">))</span>

<span class="n">crossover_</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="s1">&#39;state&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="some-more-functions-to-calculate-the-profits-loss-as-well-as-the-signal-noise-ratio">
<h3>some more functions to calculate the profits &amp; loss as well as the signal/noise ratio<a class="headerlink" href="#some-more-functions-to-calculate-the-profits-loss-as-well-as-the-signal-noise-ratio" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">signal_pnl</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">vol</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shift</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rtn</span><span class="o">/</span><span class="n">vol</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">information_ratio</span><span class="p">(</span><span class="n">pnl</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">ts_mean</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span> <span class="o">/</span> <span class="n">ts_std</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecasts</span> <span class="o">=</span> <span class="n">stocks</span> <span class="o">*</span> <span class="n">dictable</span><span class="p">(</span><span class="n">fast</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">slow</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="n">forecast</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;slow&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecasts</span> <span class="o">=</span> <span class="n">forecasts</span><span class="p">(</span><span class="n">signal</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">:</span> <span class="n">crossover_</span><span class="p">(</span><span class="n">rtn</span><span class="p">,</span> <span class="n">fast</span> <span class="o">=</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span> <span class="o">=</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecasts</span> <span class="o">=</span> <span class="n">forecasts</span><span class="p">(</span><span class="n">pnl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">signal</span><span class="p">,</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">vol</span><span class="p">:</span> <span class="n">signal_pnl</span><span class="p">(</span><span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span><span class="p">,</span> <span class="n">rtn</span> <span class="o">=</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecasts</span> <span class="o">=</span> <span class="n">forecasts</span><span class="p">(</span><span class="n">ir</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pnl</span><span class="p">:</span> <span class="n">information_ratio</span><span class="p">(</span><span class="n">pnl</span> <span class="o">=</span> <span class="n">pnl</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">forecasts</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">,</span> <span class="s1">&#39;ir&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">last</span><span class="p">,</span> <span class="n">f12</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">symbol</span><span class="o">|</span><span class="n">fast</span> <span class="o">|</span><span class="n">medium</span><span class="o">|</span><span class="n">slow</span>
<span class="n">APA</span>   <span class="o">|</span><span class="mf">0.13</span> <span class="o">|-</span><span class="mf">0.03</span> <span class="o">|-</span><span class="mf">0.10</span>
<span class="n">BKR</span>   <span class="o">|</span><span class="mf">0.06</span> <span class="o">|-</span><span class="mf">0.10</span> <span class="o">|-</span><span class="mf">0.14</span>
<span class="n">COG</span>   <span class="o">|</span><span class="mf">0.22</span> <span class="o">|</span><span class="mf">0.13</span>  <span class="o">|-</span><span class="mf">0.01</span>
<span class="n">COP</span>   <span class="o">|-</span><span class="mf">0.14</span><span class="o">|-</span><span class="mf">0.17</span> <span class="o">|-</span><span class="mf">0.19</span>
<span class="n">CVX</span>   <span class="o">|</span><span class="mf">0.47</span> <span class="o">|</span><span class="mf">0.30</span>  <span class="o">|</span><span class="mf">0.10</span>
<span class="n">CXO</span>   <span class="o">|</span><span class="mf">0.01</span> <span class="o">|-</span><span class="mf">0.14</span> <span class="o">|-</span><span class="mf">0.34</span>
<span class="n">DVN</span>   <span class="o">|</span><span class="mf">0.16</span> <span class="o">|</span><span class="mf">0.15</span>  <span class="o">|</span><span class="mf">0.16</span>
<span class="n">EOG</span>   <span class="o">|</span><span class="mf">0.16</span> <span class="o">|</span><span class="mf">0.06</span>  <span class="o">|-</span><span class="mf">0.03</span>
<span class="n">FANG</span>  <span class="o">|-</span><span class="mf">0.01</span><span class="o">|-</span><span class="mf">0.05</span> <span class="o">|-</span><span class="mf">0.18</span>
<span class="n">FTI</span>   <span class="o">|-</span><span class="mf">0.18</span><span class="o">|-</span><span class="mf">0.36</span> <span class="o">|-</span><span class="mf">0.35</span>
<span class="n">HAL</span>   <span class="o">|</span><span class="mf">0.73</span> <span class="o">|</span><span class="mf">0.47</span>  <span class="o">|</span><span class="mf">0.29</span>
<span class="n">HES</span>   <span class="o">|</span><span class="mf">0.15</span> <span class="o">|</span><span class="mf">0.02</span>  <span class="o">|-</span><span class="mf">0.01</span>
<span class="n">HFC</span>   <span class="o">|</span><span class="mf">0.86</span> <span class="o">|</span><span class="mf">0.80</span>  <span class="o">|</span><span class="mf">0.70</span>
<span class="n">KMI</span>   <span class="o">|</span><span class="mf">0.47</span> <span class="o">|</span><span class="mf">0.15</span>  <span class="o">|</span><span class="mf">0.04</span>
<span class="n">MPC</span>   <span class="o">|</span><span class="mf">0.22</span> <span class="o">|</span><span class="mf">0.45</span>  <span class="o">|</span><span class="mf">0.71</span>
<span class="n">MRO</span>   <span class="o">|</span><span class="mf">0.19</span> <span class="o">|</span><span class="mf">0.10</span>  <span class="o">|</span><span class="mf">0.09</span>
<span class="n">NOV</span>   <span class="o">|</span><span class="mf">0.10</span> <span class="o">|-</span><span class="mf">0.04</span> <span class="o">|-</span><span class="mf">0.04</span>
<span class="n">OKE</span>   <span class="o">|-</span><span class="mf">0.21</span><span class="o">|-</span><span class="mf">0.14</span> <span class="o">|-</span><span class="mf">0.06</span>
<span class="n">OXY</span>   <span class="o">|-</span><span class="mf">0.23</span><span class="o">|-</span><span class="mf">0.29</span> <span class="o">|-</span><span class="mf">0.22</span>
<span class="n">PSX</span>   <span class="o">|-</span><span class="mf">0.01</span><span class="o">|</span><span class="mf">0.11</span>  <span class="o">|</span><span class="mf">0.41</span>
<span class="n">PXD</span>   <span class="o">|</span><span class="mf">0.21</span> <span class="o">|</span><span class="mf">0.16</span>  <span class="o">|</span><span class="mf">0.21</span>
<span class="n">SLB</span>   <span class="o">|-</span><span class="mf">0.07</span><span class="o">|-</span><span class="mf">0.25</span> <span class="o">|-</span><span class="mf">0.33</span>
<span class="n">VLO</span>   <span class="o">|</span><span class="mf">0.29</span> <span class="o">|</span><span class="mf">0.28</span>  <span class="o">|</span><span class="mf">0.40</span>
<span class="n">WMB</span>   <span class="o">|</span><span class="mf">0.18</span> <span class="o">|-</span><span class="mf">0.07</span> <span class="o">|-</span><span class="mf">0.21</span>
<span class="n">XOM</span>   <span class="o">|-</span><span class="mf">0.03</span><span class="o">|-</span><span class="mf">0.28</span> <span class="o">|-</span><span class="mf">0.43</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="workflow-while-saving-to-mongodb">
<h2>Workflow while saving to MongoDB<a class="headerlink" href="#workflow-while-saving-to-mongodb" title="Permalink to this headline">¶</a></h2>
<div class="section" id="table-creation">
<h3>Table creation<a class="headerlink" href="#table-creation" title="Permalink to this headline">¶</a></h3>
<p>We create three tables dependending on the primary keys we will be
using.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idb</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">mongo_table</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span>
<span class="n">sdb</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">mongo_table</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;stock&#39;</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">])</span>
<span class="n">fdb</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">mongo_table</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;forecast&#39;</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idb</span><span class="p">()</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">Dict</span><span class="p">(</span><span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;constituents&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">constituents</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ObjectId</span><span class="p">(</span><span class="s1">&#39;602a566073531499b3861809&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="any-code-differences">
<h3>Any code differences?<a class="headerlink" href="#any-code-differences" title="Permalink to this headline">¶</a></h3>
<p>Most of the code remains the same as above, except:</p>
<ul class="simple">
<li><p>We wrap it inside a periodic_cell so it is calculated daily</p></li>
<li><p>We add reference to where we want to store it in MongoDB by specifying the db as well as the primary keys of that table</p></li>
<li><p>To run the function, we can explicitly .load() the cell from the database, checking if it even needs running and .go(), running it, or just call the cell</p></li>
</ul>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">history</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">periodic_cell</span><span class="p">(</span><span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">,</span> <span class="n">tickers</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span>      <span class="c1"># these are the inputs for the function</span>
                                            <span class="n">db</span> <span class="o">=</span> <span class="n">sdb</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">go</span><span class="p">())</span>    <span class="c1"># these define where the data goes to</span>
</pre></div>
</div>
</div>
<div class="section" id="accessing-the-data-in-mongodb">
<h3>Accessing the data in MongoDB<a class="headerlink" href="#accessing-the-data-in-mongodb" title="Permalink to this headline">¶</a></h3>
<p>The data is now in the database and can be accessed:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;stock&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39;MMM&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Open</th>
      <th>High</th>
      <th>Low</th>
      <th>Close</th>
      <th>Adj Close</th>
      <th>Volume</th>
    </tr>
    <tr>
      <th>Date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1970-01-02</th>
      <td>6.851563</td>
      <td>6.890625</td>
      <td>6.843750</td>
      <td>6.851563</td>
      <td>1.471232</td>
      <td>72000</td>
    </tr>
    <tr>
      <th>1970-01-05</th>
      <td>6.859375</td>
      <td>6.898438</td>
      <td>6.859375</td>
      <td>6.890625</td>
      <td>1.479620</td>
      <td>446400</td>
    </tr>
    <tr>
      <th>1970-01-06</th>
      <td>6.890625</td>
      <td>6.960938</td>
      <td>6.882813</td>
      <td>6.960938</td>
      <td>1.494717</td>
      <td>176000</td>
    </tr>
    <tr>
      <th>1970-01-07</th>
      <td>6.960938</td>
      <td>7.015625</td>
      <td>6.945313</td>
      <td>7.000000</td>
      <td>1.503106</td>
      <td>164800</td>
    </tr>
    <tr>
      <th>1970-01-08</th>
      <td>7.000000</td>
      <td>7.109375</td>
      <td>6.984375</td>
      <td>7.093750</td>
      <td>1.523237</td>
      <td>304000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2021-02-08</th>
      <td>179.300003</td>
      <td>180.869995</td>
      <td>179.169998</td>
      <td>180.759995</td>
      <td>179.282608</td>
      <td>2355100</td>
    </tr>
    <tr>
      <th>2021-02-09</th>
      <td>181.220001</td>
      <td>181.899994</td>
      <td>180.179993</td>
      <td>180.940002</td>
      <td>179.461151</td>
      <td>1942800</td>
    </tr>
    <tr>
      <th>2021-02-10</th>
      <td>181.880005</td>
      <td>182.380005</td>
      <td>180.639999</td>
      <td>181.080002</td>
      <td>179.600006</td>
      <td>1929000</td>
    </tr>
    <tr>
      <th>2021-02-11</th>
      <td>179.350006</td>
      <td>179.880005</td>
      <td>175.839996</td>
      <td>177.210007</td>
      <td>177.210007</td>
      <td>2187100</td>
    </tr>
    <tr>
      <th>2021-02-12</th>
      <td>177.270004</td>
      <td>178.839996</td>
      <td>177.210007</td>
      <td>178.699997</td>
      <td>178.699997</td>
      <td>1081500</td>
    </tr>
  </tbody>
</table>
<p>12895 rows × 6 columns</p>
</div><div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="k">lambda</span> <span class="n">history</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">adj</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">history</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">periodic_cell</span><span class="p">(</span><span class="n">getitem</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">history</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">,</span>
                                                            <span class="n">db</span> <span class="o">=</span> <span class="n">sdb</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;adj&#39;</span><span class="p">)())</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">rtn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">adj</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">periodic_cell</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">adj</span><span class="p">,</span>
                                                        <span class="n">db</span> <span class="o">=</span> <span class="n">sdb</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;rtn&#39;</span><span class="p">)())</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">vol</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">periodic_cell</span><span class="p">(</span><span class="n">ewmstd</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span>  <span class="mi">30</span><span class="p">,</span>
                                                        <span class="n">db</span> <span class="o">=</span> <span class="n">sdb</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;vol&#39;</span><span class="p">)())</span>
</pre></div>
</div>
</div>
<div class="section" id="calculating-the-forecasts-saving-them">
<h3>Calculating the forecasts &amp; saving them<a class="headerlink" href="#calculating-the-forecasts-saving-them" title="Permalink to this headline">¶</a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecasts</span> <span class="o">=</span> <span class="n">stocks</span> <span class="o">*</span> <span class="n">dictable</span><span class="p">(</span><span class="n">fast</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span> <span class="n">slow</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">24</span><span class="p">],</span> <span class="n">forecast</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="s1">&#39;medium&#39;</span><span class="p">,</span> <span class="s1">&#39;slow&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecasts</span> <span class="o">=</span> <span class="n">forecasts</span><span class="p">(</span><span class="n">signal</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">forecast</span><span class="p">:</span> <span class="n">periodic_cell</span><span class="p">(</span><span class="n">crossover_</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">fast</span> <span class="o">=</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span> <span class="o">=</span> <span class="n">slow</span><span class="p">,</span> <span class="n">vol</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
                                            <span class="n">db</span> <span class="o">=</span> <span class="n">fdb</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">forecast</span> <span class="o">=</span> <span class="n">forecast</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;signal&#39;</span><span class="p">)())</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecasts</span> <span class="o">=</span> <span class="n">forecasts</span><span class="p">(</span><span class="n">pnl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">signal</span><span class="p">,</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">vol</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">forecast</span><span class="p">:</span> <span class="n">periodic_cell</span><span class="p">(</span><span class="n">signal_pnl</span><span class="p">,</span> <span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span><span class="p">,</span> <span class="n">rtn</span> <span class="o">=</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">vol</span> <span class="o">=</span> <span class="n">vol</span><span class="p">,</span>
                                                        <span class="n">db</span> <span class="o">=</span> <span class="n">fdb</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">forecast</span> <span class="o">=</span> <span class="n">forecast</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;pnl&#39;</span><span class="p">)())</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">forecasts</span> <span class="o">=</span> <span class="n">forecasts</span><span class="p">(</span><span class="n">ir</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pnl</span><span class="p">:</span> <span class="n">information_ratio</span><span class="p">(</span><span class="n">pnl</span> <span class="o">=</span> <span class="n">pnl</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">forecasts</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">,</span> <span class="s1">&#39;ir&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">last</span><span class="p">,</span> <span class="n">f12</span><span class="p">]))</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">symbol</span><span class="o">|</span><span class="n">fast</span> <span class="o">|</span><span class="n">medium</span><span class="o">|</span><span class="n">slow</span>
<span class="n">APA</span>   <span class="o">|</span><span class="mf">0.13</span> <span class="o">|-</span><span class="mf">0.02</span> <span class="o">|-</span><span class="mf">0.09</span>
<span class="n">BKR</span>   <span class="o">|</span><span class="mf">0.04</span> <span class="o">|-</span><span class="mf">0.12</span> <span class="o">|-</span><span class="mf">0.16</span>
<span class="n">COG</span>   <span class="o">|</span><span class="mf">0.22</span> <span class="o">|</span><span class="mf">0.12</span>  <span class="o">|-</span><span class="mf">0.01</span>
<span class="n">COP</span>   <span class="o">|-</span><span class="mf">0.16</span><span class="o">|-</span><span class="mf">0.18</span> <span class="o">|-</span><span class="mf">0.20</span>
<span class="n">CVX</span>   <span class="o">|</span><span class="mf">0.45</span> <span class="o">|</span><span class="mf">0.29</span>  <span class="o">|</span><span class="mf">0.08</span>
<span class="n">CXO</span>   <span class="o">|</span><span class="mf">0.04</span> <span class="o">|-</span><span class="mf">0.13</span> <span class="o">|-</span><span class="mf">0.36</span>
<span class="n">DVN</span>   <span class="o">|</span><span class="mf">0.21</span> <span class="o">|</span><span class="mf">0.22</span>  <span class="o">|</span><span class="mf">0.24</span>
<span class="n">EOG</span>   <span class="o">|</span><span class="mf">0.17</span> <span class="o">|</span><span class="mf">0.06</span>  <span class="o">|-</span><span class="mf">0.02</span>
<span class="n">FANG</span>  <span class="o">|</span><span class="mf">0.01</span> <span class="o">|-</span><span class="mf">0.04</span> <span class="o">|-</span><span class="mf">0.24</span>
<span class="n">FTI</span>   <span class="o">|-</span><span class="mf">0.19</span><span class="o">|-</span><span class="mf">0.37</span> <span class="o">|-</span><span class="mf">0.34</span>
<span class="n">HAL</span>   <span class="o">|</span><span class="mf">0.68</span> <span class="o">|</span><span class="mf">0.41</span>  <span class="o">|</span><span class="mf">0.23</span>
<span class="n">HES</span>   <span class="o">|</span><span class="mf">0.15</span> <span class="o">|</span><span class="mf">0.02</span>  <span class="o">|-</span><span class="mf">0.00</span>
<span class="n">HFC</span>   <span class="o">|</span><span class="mf">0.88</span> <span class="o">|</span><span class="mf">0.84</span>  <span class="o">|</span><span class="mf">0.74</span>
<span class="n">KMI</span>   <span class="o">|</span><span class="mf">0.46</span> <span class="o">|</span><span class="mf">0.16</span>  <span class="o">|</span><span class="mf">0.08</span>
<span class="n">MPC</span>   <span class="o">|</span><span class="mf">0.16</span> <span class="o">|</span><span class="mf">0.40</span>  <span class="o">|</span><span class="mf">0.67</span>
<span class="n">MRO</span>   <span class="o">|</span><span class="mf">0.19</span> <span class="o">|</span><span class="mf">0.09</span>  <span class="o">|</span><span class="mf">0.09</span>
<span class="n">NOV</span>   <span class="o">|</span><span class="mf">0.10</span> <span class="o">|-</span><span class="mf">0.04</span> <span class="o">|-</span><span class="mf">0.03</span>
<span class="n">OKE</span>   <span class="o">|-</span><span class="mf">0.24</span><span class="o">|-</span><span class="mf">0.16</span> <span class="o">|-</span><span class="mf">0.06</span>
<span class="n">OXY</span>   <span class="o">|-</span><span class="mf">0.25</span><span class="o">|-</span><span class="mf">0.31</span> <span class="o">|-</span><span class="mf">0.23</span>
<span class="n">PSX</span>   <span class="o">|-</span><span class="mf">0.04</span><span class="o">|</span><span class="mf">0.09</span>  <span class="o">|</span><span class="mf">0.37</span>
<span class="n">PXD</span>   <span class="o">|</span><span class="mf">0.15</span> <span class="o">|</span><span class="mf">0.10</span>  <span class="o">|</span><span class="mf">0.15</span>
<span class="n">SLB</span>   <span class="o">|-</span><span class="mf">0.07</span><span class="o">|-</span><span class="mf">0.24</span> <span class="o">|-</span><span class="mf">0.32</span>
<span class="n">VLO</span>   <span class="o">|</span><span class="mf">0.25</span> <span class="o">|</span><span class="mf">0.26</span>  <span class="o">|</span><span class="mf">0.40</span>
<span class="n">WMB</span>   <span class="o">|</span><span class="mf">0.17</span> <span class="o">|-</span><span class="mf">0.08</span> <span class="o">|-</span><span class="mf">0.22</span>
<span class="n">XOM</span>   <span class="o">|-</span><span class="mf">0.06</span><span class="o">|-</span><span class="mf">0.31</span> <span class="o">|-</span><span class="mf">0.46</span>
</pre></div>
</div>
</div>
<div class="section" id="accessing-running-the-graph-once-the-graph-has-been-created">
<h3>Accessing &amp; running the graph once the graph has been created<a class="headerlink" href="#accessing-running-the-graph-once-the-graph-has-been-created" title="Permalink to this headline">¶</a></h3>
<p>We can access the data or the cell:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">get_cell</span><span class="p">(</span><span class="s1">&#39;forecast&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39;APA&#39;</span><span class="p">,</span> <span class="n">forecast</span> <span class="o">=</span> <span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;signal&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">periodic_cell</span>
<span class="n">updated</span><span class="p">:</span>
    <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">17</span> <span class="mi">19</span><span class="p">:</span><span class="mi">43</span><span class="p">:</span><span class="mf">15.957000</span>
<span class="n">_period</span><span class="p">:</span>
    <span class="mi">1</span><span class="n">b</span>
<span class="n">db</span><span class="p">:</span>
    <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="o">&lt;</span><span class="n">function</span> <span class="n">mongo_table</span> <span class="n">at</span> <span class="mh">0x000001CBBED713A0</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s1">&#39;forecast&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">,</span> <span class="s1">&#39;forecast&#39;</span><span class="p">])</span>
<span class="n">_id</span><span class="p">:</span>
    <span class="mi">602</span><span class="n">a86fb4de6ffaf1c045c8f</span>
<span class="n">_pk</span><span class="p">:</span>
    <span class="p">[</span><span class="s1">&#39;forecast&#39;</span><span class="p">,</span> <span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">]</span>
<span class="n">a</span><span class="p">:</span>
    <span class="n">updated</span><span class="p">:</span>
        <span class="kc">None</span>
    <span class="n">_period</span><span class="p">:</span>
        <span class="mi">1</span><span class="n">b</span>
    <span class="n">db</span><span class="p">:</span>
        <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="o">&lt;</span><span class="n">function</span> <span class="n">mongo_table</span> <span class="n">at</span> <span class="mh">0x000001CBBED713A0</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s1">&#39;stock&#39;</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">])</span>
    <span class="n">item</span><span class="p">:</span>
        <span class="n">rtn</span>
    <span class="n">symbol</span><span class="p">:</span>
        <span class="n">APA</span>
    <span class="n">function</span><span class="p">:</span>
        <span class="kc">None</span>
<span class="n">data</span><span class="p">:</span>
    <span class="n">Date</span>
    <span class="mi">1979</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">15</span>         <span class="n">NaN</span>
    <span class="mi">1979</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">16</span>    <span class="mf">0.075685</span>
    <span class="mi">1979</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">17</span>   <span class="o">-</span><span class="mf">0.068899</span>
    <span class="mi">1979</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">18</span>   <span class="o">-</span><span class="mf">0.103022</span>
    <span class="mi">1979</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">21</span>   <span class="o">-</span><span class="mf">0.151627</span>
                    <span class="o">...</span>
    <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">09</span>    <span class="mf">0.347606</span>
    <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">0.489170</span>
    <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">11</span>   <span class="o">-</span><span class="mf">0.578565</span>
    <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">12</span>    <span class="mf">0.100337</span>
    <span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">16</span>    <span class="mf">1.163557</span>
    <span class="n">Length</span><span class="p">:</span> <span class="mi">10530</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
<span class="n">fast</span><span class="p">:</span>
    <span class="mi">2</span>
<span class="n">forecast</span><span class="p">:</span>
    <span class="n">fast</span>
<span class="n">item</span><span class="p">:</span>
    <span class="n">signal</span>
<span class="n">slow</span><span class="p">:</span>
    <span class="mi">6</span>
<span class="n">state</span><span class="p">:</span>
    <span class="n">fast</span><span class="p">:</span>
        <span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;t0&#39;</span><span class="p">:</span> <span class="mf">0.9999999999999999</span><span class="p">,</span> <span class="s1">&#39;t1&#39;</span><span class="p">:</span> <span class="mf">0.46353936200681184</span><span class="p">}}</span>
    <span class="n">slow</span><span class="p">:</span>
        <span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;t0&#39;</span><span class="p">:</span> <span class="mf">0.9999999999999997</span><span class="p">,</span> <span class="s1">&#39;t1&#39;</span><span class="p">:</span> <span class="mf">0.2672723621042594</span><span class="p">}}</span>
    <span class="n">vol</span><span class="p">:</span>
        <span class="p">{</span><span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;t0&#39;</span><span class="p">:</span> <span class="mf">0.9999999999999983</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">:</span> <span class="mf">0.02845240938173902</span><span class="p">}}</span>
<span class="n">symbol</span><span class="p">:</span>
    <span class="n">APA</span>
<span class="n">vol</span><span class="p">:</span>
    <span class="mi">30</span>
<span class="n">function</span><span class="p">:</span>
    <span class="o">&lt;</span><span class="n">function</span> <span class="n">crossover_</span> <span class="n">at</span> <span class="mh">0x000001CBC2DFC670</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>And now that the graph has been created, you can actually trigger it
just by loading. i.e. The code below will give you the fast signal for
APA and will ensure it is up-to-date too:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">get_cell</span><span class="p">(</span><span class="s1">&#39;forecast&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="s1">&#39;APA&#39;</span><span class="p">,</span> <span class="n">forecast</span> <span class="o">=</span> <span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;signal&#39;</span><span class="p">)</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Date</span>
<span class="mi">1979</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">15</span>         <span class="n">NaN</span>
<span class="mi">1979</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">16</span>    <span class="mf">0.075685</span>
<span class="mi">1979</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">17</span>   <span class="o">-</span><span class="mf">0.068899</span>
<span class="mi">1979</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">18</span>   <span class="o">-</span><span class="mf">0.103022</span>
<span class="mi">1979</span><span class="o">-</span><span class="mi">05</span><span class="o">-</span><span class="mi">21</span>   <span class="o">-</span><span class="mf">0.151627</span>
                <span class="o">...</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">09</span>    <span class="mf">0.347606</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">10</span>    <span class="mf">0.489170</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">11</span>   <span class="o">-</span><span class="mf">0.578565</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">12</span>    <span class="mf">0.100337</span>
<span class="mi">2021</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">16</span>    <span class="mf">1.163557</span>
<span class="n">Length</span><span class="p">:</span> <span class="mi">10530</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="comparison-of-the-two-workflows">
<h2>Comparison of the two workflows<a class="headerlink" href="#comparison-of-the-two-workflows" title="Permalink to this headline">¶</a></h2>
<p>Saving to the database:</p>
<ul class="simple">
<li><p>does require some (but really not much) additional code to specify where each data item goes to</p></li>
<li><p>slows down the calculation</p></li>
</ul>
<p>Conversely,</p>
<ul class="simple">
<li><p>We get full persistency: We can access each part of the graph with full visibility on the inputs, the function used to calculate the result, the function output(s), the location of where the data is</p></li>
</ul>
<p>stored and the time it was last updated as well as the periodicity it is calculated.
* We get full audit * Each node will manage its schedule, ensuring data is up-to-date
* Can run just the parts of the graph we are interested in (and can run in parallel)</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">pyg</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="base.html">pyg.base</a></li>
<li class="toctree-l1"><a class="reference internal" href="mongo.html">pyg.mongo</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeseries.html">pyg.timeseries</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_dict.html">tutorial: pyg.base</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab/tutorial_dictable.html">tutorial: pyg.base.dictable</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_mongo.html">tutorial: pyg.mongo</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_timeseries.html">tutorial: pyg.timeseries</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">tutorial: pyg.base.cell</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#cell-101">Cell 101</a></li>
<li class="toctree-l2"><a class="reference internal" href="#workflow-without-saving-to-the-database">Workflow without saving to the database</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#some-more-functions-to-calculate-the-profits-loss-as-well-as-the-signal-noise-ratio">some more functions to calculate the profits &amp; loss as well as the signal/noise ratio</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#workflow-while-saving-to-mongodb">Workflow while saving to MongoDB</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#table-creation">Table creation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#any-code-differences">Any code differences?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#accessing-the-data-in-mongodb">Accessing the data in MongoDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="#calculating-the-forecasts-saving-them">Calculating the forecasts &amp; saving them</a></li>
<li class="toctree-l3"><a class="reference internal" href="#accessing-running-the-graph-once-the-graph-has-been-created">Accessing &amp; running the graph once the graph has been created</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#comparison-of-the-two-workflows">Comparison of the two workflows</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="tutorial_timeseries.html" title="previous chapter">tutorial: pyg.timeseries</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Yoav Git.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/tutorial_cell.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>