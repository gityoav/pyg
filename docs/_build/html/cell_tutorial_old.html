
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tutorial: simple stock trading &#8212; pyg 0.0.1 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="tutorial-simple-stock-trading">
<h1>tutorial: simple stock trading<a class="headerlink" href="#tutorial-simple-stock-trading" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial we are going to build a simple trading system from scratch.
We pip install yfinance from &lt;<a class="reference external" href="https://github.com/ranaroussi/yfinance">https://github.com/ranaroussi/yfinance</a>&gt;</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyg</span> <span class="kn">import</span> <span class="o">*</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
</pre></div>
</div>
<div class="section" id="list-of-stocks">
<h2>list of stocks<a class="headerlink" href="#list-of-stocks" title="Permalink to this headline">¶</a></h2>
<p>We download the S&amp;P 500 stocks from &lt;<a class="reference external" href="https://datahub.io/core/s-and-p-500-companies#resource-constituents">https://datahub.io/core/s-and-p-500-companies#resource-constituents</a>&gt;
and loaded it into a constituents_csv dictable</p>
<p>constituents = dictable(read_csv(‘d:/dropbox/yoav/python/pyg/docs/constituents_csv.csv’)).rename(lower)</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyg</span> <span class="kn">import</span> <span class="o">*</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">idb</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">mongo_table</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">idb</span><span class="p">()</span><span class="o">.</span><span class="n">insert_one</span><span class="p">(</span><span class="n">Dict</span><span class="p">(</span><span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;constituents_csv&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">constituents_csv</span><span class="p">))</span>
</pre></div>
</div>
<p>In the future, to read it we can access it directly:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">constituents_csv</span>  <span class="o">=</span> <span class="n">get_cell</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;constituents_csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dictable</span><span class="p">[</span><span class="mi">505</span> <span class="n">x</span> <span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">symbol</span><span class="o">|</span><span class="n">name</span>                  <span class="o">|</span><span class="n">sector</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">MMM</span>   <span class="o">|</span><span class="mi">3</span><span class="n">M</span> <span class="n">Company</span>            <span class="o">|</span><span class="n">Industrials</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">AOS</span>   <span class="o">|</span><span class="n">A</span><span class="o">.</span><span class="n">O</span><span class="o">.</span> <span class="n">Smith</span> <span class="n">Corp</span>       <span class="o">|</span><span class="n">Industrials</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ABT</span>   <span class="o">|</span><span class="n">Abbott</span> <span class="n">Laboratories</span>   <span class="o">|</span><span class="n">Health</span> <span class="n">Care</span>
<span class="gp">&gt;&gt;&gt; </span><span class="o">...</span><span class="mi">505</span> <span class="n">rows</span><span class="o">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ZBH</span>   <span class="o">|</span><span class="n">Zimmer</span> <span class="n">Biomet</span> <span class="n">Holdings</span><span class="o">|</span><span class="n">Health</span> <span class="n">Care</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ZION</span>  <span class="o">|</span><span class="n">Zions</span> <span class="n">Bancorp</span>         <span class="o">|</span><span class="n">Financials</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ZTS</span>   <span class="o">|</span><span class="n">Zoetis</span>                <span class="o">|</span><span class="n">Health</span> <span class="n">Care</span>
</pre></div>
</div>
</div>
<div class="section" id="downloading-price-data">
<h2>downloading price data<a class="headerlink" href="#downloading-price-data" title="Permalink to this headline">¶</a></h2>
<p>We set up a database to save the data:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">pyg</span> <span class="kn">import</span> <span class="o">*</span><span class="p">;</span> <span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">idb</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">mongo_table</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="s1">&#39;item&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sdb</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">mongo_table</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">table</span> <span class="o">=</span> <span class="s1">&#39;stock&#39;</span><span class="p">,</span> <span class="n">pk</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">constituents_csv</span>  <span class="o">=</span> <span class="n">get_cell</span><span class="p">(</span><span class="s1">&#39;items&#39;</span><span class="p">,</span> <span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;constituents_csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stocks</span> <span class="o">=</span> <span class="n">constituents_csv</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">sector</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Health Care&#39;</span><span class="p">,</span> <span class="s1">&#39;Energy&#39;</span><span class="p">,</span> <span class="s1">&#39;Materials&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">history</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">sector</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">periodic_cell</span><span class="p">(</span><span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">,</span> <span class="n">tickers</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span>              <span class="c1"># these are the inputs for the function</span>
<span class="gp">&gt;&gt;&gt; </span>                                                    <span class="n">db</span> <span class="o">=</span> <span class="n">sdb</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;history&#39;</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">go</span><span class="p">())</span>    <span class="c1"># these define where the data goes to</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="k">lambda</span> <span class="n">history</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">history</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="c1">## remove empty stocks</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">adj</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">history</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">periodic_cell</span><span class="p">(</span><span class="n">getitem</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">history</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;Adj Close&#39;</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="n">sdb</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;adj&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">go</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">diff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">adj</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">periodic_cell</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">adj</span><span class="p">,</span> <span class="n">db</span> <span class="o">=</span> <span class="n">sdb</span><span class="p">,</span> <span class="n">symbol</span> <span class="o">=</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">item</span> <span class="o">=</span> <span class="s1">&#39;diff&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span><span class="o">.</span><span class="n">go</span><span class="p">())</span>
</pre></div>
</div>
<p>cell_item(get_cell(‘stock’, ‘demo’, item = ‘history’, symbol = ‘MMM’))
get_data(‘stock’, ‘demo’, item = ‘history’, symbol = ‘MMM’)
get_data(‘items’, ‘demo’, item = ‘constituents_csv’)</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">constituents_csv</span><span class="o">.</span><span class="n">listby</span><span class="p">(</span><span class="s1">&#39;sector&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">do</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)[[</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">))</span> <span class="c1">## number of stocks per sector</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sector</span>                <span class="o">|</span><span class="n">name</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Communication</span> <span class="n">Services</span><span class="o">|</span><span class="mi">26</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span>                <span class="o">|</span><span class="mi">26</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Materials</span>             <span class="o">|</span><span class="mi">28</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Utilities</span>             <span class="o">|</span><span class="mi">28</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Real</span> <span class="n">Estate</span>           <span class="o">|</span><span class="mi">31</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Consumer</span> <span class="n">Staples</span>      <span class="o">|</span><span class="mi">33</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Consumer</span> <span class="n">Discretionary</span><span class="o">|</span><span class="mi">61</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Health</span> <span class="n">Care</span>           <span class="o">|</span><span class="mi">62</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Financials</span>            <span class="o">|</span><span class="mi">66</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Information</span> <span class="n">Technology</span><span class="o">|</span><span class="mi">71</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Industrials</span>           <span class="o">|</span><span class="mi">73</span>
</pre></div>
</div>
<p>Now we dowload the history from yahoo.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stocks</span> <span class="o">=</span> <span class="n">constituents_csv</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">sector</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Communication Services&#39;</span><span class="p">,</span> <span class="s1">&#39;Energy&#39;</span><span class="p">,</span> <span class="s1">&#39;Materials&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">history</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">symbol</span><span class="p">:</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">adj</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">history</span><span class="p">:</span> <span class="n">history</span><span class="p">[</span><span class="s1">&#39;Adj Close&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">rtn</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">adj</span><span class="p">:</span> <span class="n">diff</span><span class="p">(</span><span class="n">adj</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stocks</span> <span class="o">=</span> <span class="n">stocks</span><span class="p">(</span><span class="n">volatility</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">rtn</span><span class="p">:</span> <span class="n">ewmstd</span><span class="p">(</span><span class="n">rtn</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
</pre></div>
</div>
<p>One of the simplest predictors we can have is an exponential moving average cross-over</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">crossover</span><span class="p">(</span><span class="n">rtn</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">volatility</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>   <span class="k">return</span> <span class="p">(</span><span class="n">ewma</span><span class="p">(</span><span class="n">rtn</span><span class="p">,</span> <span class="n">fast</span><span class="p">)</span> <span class="o">-</span> <span class="n">ewma</span><span class="p">(</span><span class="n">rtn</span><span class="p">,</span> <span class="n">slow</span><span class="p">))</span><span class="o">/</span><span class="n">volatility</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cross_overs</span> <span class="o">=</span> <span class="n">dictable</span><span class="p">(</span><span class="n">fast</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">63</span><span class="p">],</span> <span class="n">slow</span> <span class="o">=</span> <span class="p">[</span><span class="mi">21</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span><span class="mi">256</span><span class="p">],</span> <span class="n">predictor</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;week-month&#39;</span><span class="p">,</span> <span class="s1">&#39;month-qurter&#39;</span><span class="p">,</span> <span class="s1">&#39;quarter-year&#39;</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stock_xover</span> <span class="o">=</span> <span class="n">stocks</span>  <span class="o">*</span> <span class="n">cross_overs</span>  <span class="c1"># cross join</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stock_xover</span> <span class="o">=</span> <span class="n">stock_xover</span><span class="p">(</span><span class="n">signal</span> <span class="o">=</span> <span class="n">crossover</span><span class="p">)</span> <span class="c1"># the columns already match parameter names.</span>
</pre></div>
</div>
<p>To calculate profits &amp; loss:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">pnl</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">rtn</span><span class="p">,</span> <span class="n">volatility</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">return</span> <span class="n">shift</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rtn</span><span class="o">/</span><span class="n">volatility</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">information_ratio</span><span class="p">(</span><span class="n">pnl</span><span class="p">):</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="k">return</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">ts_mean</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span> <span class="o">/</span> <span class="n">ts_std</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stock_xover</span> <span class="o">=</span> <span class="n">stock_xover</span><span class="p">(</span><span class="n">pnl</span> <span class="o">=</span> <span class="n">pnl</span><span class="p">)(</span><span class="n">ir</span> <span class="o">=</span> <span class="n">information_ratio</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">stock_xover</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">sector</span> <span class="o">=</span> <span class="s1">&#39;Energy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pivot</span><span class="p">([</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;symbol&#39;</span><span class="p">],</span> <span class="s1">&#39;predictor&#39;</span><span class="p">,</span> <span class="s1">&#39;ir&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">last</span><span class="p">,</span> <span class="n">f12</span><span class="p">]))</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sector</span><span class="o">|</span><span class="n">symbol</span><span class="o">|</span><span class="n">month</span><span class="o">-</span><span class="n">qurter</span><span class="o">|</span><span class="n">quarter</span><span class="o">-</span><span class="n">year</span><span class="o">|</span><span class="n">week</span><span class="o">-</span><span class="n">month</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">APA</span>   <span class="o">|-</span><span class="mf">0.16</span>       <span class="o">|-</span><span class="mf">0.18</span>       <span class="o">|-</span><span class="mf">0.12</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">BKR</span>   <span class="o">|-</span><span class="mf">0.09</span>       <span class="o">|-</span><span class="mf">0.03</span>       <span class="o">|-</span><span class="mf">0.18</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">COG</span>   <span class="o">|-</span><span class="mf">0.13</span>       <span class="o">|-</span><span class="mf">0.12</span>       <span class="o">|</span><span class="mf">0.06</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">COP</span>   <span class="o">|-</span><span class="mf">0.19</span>       <span class="o">|-</span><span class="mf">0.11</span>       <span class="o">|-</span><span class="mf">0.24</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">CVX</span>   <span class="o">|-</span><span class="mf">0.22</span>       <span class="o">|-</span><span class="mf">0.13</span>       <span class="o">|</span><span class="mf">0.15</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">CXO</span>   <span class="o">|-</span><span class="mf">0.39</span>       <span class="o">|-</span><span class="mf">0.34</span>       <span class="o">|-</span><span class="mf">0.25</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">DVN</span>   <span class="o">|</span><span class="mf">0.24</span>        <span class="o">|</span><span class="mf">0.11</span>        <span class="o">|</span><span class="mf">0.20</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">EOG</span>   <span class="o">|-</span><span class="mf">0.09</span>       <span class="o">|-</span><span class="mf">0.07</span>       <span class="o">|-</span><span class="mf">0.02</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">FANG</span>  <span class="o">|-</span><span class="mf">0.22</span>       <span class="o">|-</span><span class="mf">0.12</span>       <span class="o">|-</span><span class="mf">0.16</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">FTI</span>   <span class="o">|-</span><span class="mf">0.07</span>       <span class="o">|</span><span class="mf">0.17</span>        <span class="o">|-</span><span class="mf">0.39</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">HAL</span>   <span class="o">|</span><span class="mf">0.14</span>        <span class="o">|</span><span class="mf">0.20</span>        <span class="o">|</span><span class="mf">0.35</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">HES</span>   <span class="o">|</span><span class="mf">0.09</span>        <span class="o">|</span><span class="mf">0.05</span>        <span class="o">|-</span><span class="mf">0.01</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">HFC</span>   <span class="o">|</span><span class="mf">0.59</span>        <span class="o">|</span><span class="mf">0.63</span>        <span class="o">|</span><span class="mf">0.79</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">KMI</span>   <span class="o">|</span><span class="mf">0.21</span>        <span class="o">|</span><span class="mf">0.32</span>        <span class="o">|</span><span class="mf">0.04</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">MPC</span>   <span class="o">|</span><span class="mf">0.55</span>        <span class="o">|</span><span class="mf">0.29</span>        <span class="o">|</span><span class="mf">0.64</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">MRO</span>   <span class="o">|</span><span class="mf">0.13</span>        <span class="o">|</span><span class="mf">0.15</span>        <span class="o">|</span><span class="mf">0.10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">NOV</span>   <span class="o">|</span><span class="mf">0.10</span>        <span class="o">|</span><span class="mf">0.20</span>        <span class="o">|-</span><span class="mf">0.13</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">OKE</span>   <span class="o">|</span><span class="mf">0.06</span>        <span class="o">|</span><span class="mf">0.39</span>        <span class="o">|-</span><span class="mf">0.07</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">OXY</span>   <span class="o">|-</span><span class="mf">0.07</span>       <span class="o">|-</span><span class="mf">0.04</span>       <span class="o">|-</span><span class="mf">0.23</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">PSX</span>   <span class="o">|</span><span class="mf">0.68</span>        <span class="o">|</span><span class="mf">0.44</span>        <span class="o">|</span><span class="mf">0.24</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">PXD</span>   <span class="o">|</span><span class="mf">0.22</span>        <span class="o">|</span><span class="mf">0.16</span>        <span class="o">|</span><span class="mf">0.13</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">SLB</span>   <span class="o">|-</span><span class="mf">0.29</span>       <span class="o">|-</span><span class="mf">0.12</span>       <span class="o">|-</span><span class="mf">0.32</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">VLO</span>   <span class="o">|</span><span class="mf">0.43</span>        <span class="o">|</span><span class="mf">0.43</span>        <span class="o">|</span><span class="mf">0.28</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">WMB</span>   <span class="o">|-</span><span class="mf">0.18</span>       <span class="o">|</span><span class="mf">0.21</span>        <span class="o">|-</span><span class="mf">0.16</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span><span class="o">|</span><span class="n">XOM</span>   <span class="o">|-</span><span class="mf">0.48</span>       <span class="o">|-</span><span class="mf">0.15</span>       <span class="o">|-</span><span class="mf">0.34</span>
</pre></div>
</div>
<p>Note how little code we need. Most of our code is declarative, we spend most of the time writing the signal generation, profit and loss &amp; information ratio calculation.
The boilerplate associated with data management and parameters tracking is handled by dictable.
Also note that unlike pandas, the cells in the table are not meant to be numbers, they are proper objects: timeseries, functions, parameters etc.</p>
</div>
<div class="section" id="example-extended-analysis">
<h2>Example: Extended analysis<a class="headerlink" href="#example-extended-analysis" title="Permalink to this headline">¶</a></h2>
<p>Suppose we now wanted the average result per sector…</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stock_xover</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;sector&#39;</span><span class="p">,</span> <span class="s1">&#39;predictor&#39;</span><span class="p">,</span> <span class="s1">&#39;ir&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">f12</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sector</span>                <span class="o">|</span><span class="n">month</span><span class="o">-</span><span class="n">qurter</span><span class="o">|</span><span class="n">quarter</span><span class="o">-</span><span class="n">year</span><span class="o">|</span><span class="n">week</span><span class="o">-</span><span class="n">month</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Communication</span> <span class="n">Services</span><span class="o">|</span><span class="mf">0.01</span>        <span class="o">|</span><span class="mf">0.11</span>        <span class="o">|-</span><span class="mf">0.04</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Energy</span>                <span class="o">|</span><span class="mf">0.03</span>        <span class="o">|</span><span class="mf">0.09</span>        <span class="o">|</span><span class="mf">0.01</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Materials</span>             <span class="o">|-</span><span class="mf">0.05</span>       <span class="o">|</span><span class="mf">0.03</span>        <span class="o">|-</span><span class="mf">0.03</span>
</pre></div>
</div>
<p>Or suppose we want to analyse performance per year… We don’t need to re-write our code. Here is what we do:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">per_year</span> <span class="o">=</span> <span class="n">stock_xover</span> <span class="o">*</span> <span class="nb">dict</span><span class="p">(</span><span class="n">year</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">2020</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">per_year</span> <span class="o">=</span> <span class="n">per_year</span><span class="p">(</span><span class="n">pnl</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">pnl</span><span class="p">,</span> <span class="n">year</span><span class="p">:</span> <span class="n">pnl</span><span class="p">[</span><span class="n">dt</span><span class="p">(</span><span class="n">year</span><span class="p">):</span> <span class="n">dt</span><span class="p">(</span><span class="n">year</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">per_year</span> <span class="o">=</span> <span class="n">per_year</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pnl</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">pnl</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">per_year</span><span class="o">.</span><span class="n">inc</span><span class="p">(</span><span class="n">sector</span> <span class="o">=</span> <span class="s1">&#39;Communication Services&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;predictor&#39;</span><span class="p">,</span> <span class="s1">&#39;ir&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">f12</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">year</span><span class="o">|</span><span class="n">month</span><span class="o">-</span><span class="n">qurter</span><span class="o">|</span><span class="n">quarter</span><span class="o">-</span><span class="n">year</span><span class="o">|</span><span class="n">week</span><span class="o">-</span><span class="n">month</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2000</span><span class="o">|-</span><span class="mf">0.18</span>       <span class="o">|-</span><span class="mf">0.04</span>       <span class="o">|-</span><span class="mf">0.18</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2001</span><span class="o">|-</span><span class="mf">0.18</span>       <span class="o">|-</span><span class="mf">0.04</span>       <span class="o">|-</span><span class="mf">0.18</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2002</span><span class="o">|-</span><span class="mf">0.16</span>       <span class="o">|-</span><span class="mf">0.00</span>       <span class="o">|-</span><span class="mf">0.17</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2003</span><span class="o">|-</span><span class="mf">0.16</span>       <span class="o">|-</span><span class="mf">0.00</span>       <span class="o">|-</span><span class="mf">0.17</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2004</span><span class="o">|-</span><span class="mf">0.16</span>       <span class="o">|-</span><span class="mf">0.00</span>       <span class="o">|-</span><span class="mf">0.17</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2005</span><span class="o">|-</span><span class="mf">0.09</span>       <span class="o">|</span><span class="mf">0.03</span>        <span class="o">|-</span><span class="mf">0.10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2006</span><span class="o">|-</span><span class="mf">0.10</span>       <span class="o">|</span><span class="mf">0.03</span>        <span class="o">|-</span><span class="mf">0.11</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2007</span><span class="o">|-</span><span class="mf">0.14</span>       <span class="o">|</span><span class="mf">0.02</span>        <span class="o">|-</span><span class="mf">0.16</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2008</span><span class="o">|-</span><span class="mf">0.14</span>       <span class="o">|</span><span class="mf">0.02</span>        <span class="o">|-</span><span class="mf">0.16</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2009</span><span class="o">|-</span><span class="mf">0.13</span>       <span class="o">|</span><span class="mf">0.02</span>        <span class="o">|-</span><span class="mf">0.12</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2010</span><span class="o">|-</span><span class="mf">0.12</span>       <span class="o">|</span><span class="mf">0.03</span>        <span class="o">|-</span><span class="mf">0.12</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2011</span><span class="o">|-</span><span class="mf">0.12</span>       <span class="o">|</span><span class="mf">0.03</span>        <span class="o">|-</span><span class="mf">0.12</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2012</span><span class="o">|-</span><span class="mf">0.14</span>       <span class="o">|</span><span class="mf">0.02</span>        <span class="o">|-</span><span class="mf">0.15</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2013</span><span class="o">|-</span><span class="mf">0.11</span>       <span class="o">|</span><span class="mf">0.01</span>        <span class="o">|-</span><span class="mf">0.10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2014</span><span class="o">|-</span><span class="mf">0.11</span>       <span class="o">|</span><span class="mf">0.01</span>        <span class="o">|-</span><span class="mf">0.10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2015</span><span class="o">|-</span><span class="mf">0.11</span>       <span class="o">|</span><span class="mf">0.01</span>        <span class="o">|-</span><span class="mf">0.10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2016</span><span class="o">|-</span><span class="mf">0.11</span>       <span class="o">|</span><span class="mf">0.01</span>        <span class="o">|-</span><span class="mf">0.10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2017</span><span class="o">|-</span><span class="mf">0.11</span>       <span class="o">|</span><span class="mf">0.01</span>        <span class="o">|-</span><span class="mf">0.10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2018</span><span class="o">|-</span><span class="mf">0.11</span>       <span class="o">|</span><span class="mf">0.01</span>        <span class="o">|-</span><span class="mf">0.10</span>
<span class="gp">&gt;&gt;&gt; </span><span class="mi">2019</span><span class="o">|-</span><span class="mf">0.07</span>       <span class="o">|</span><span class="mf">0.01</span>        <span class="o">|-</span><span class="mf">0.08</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">pyg</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="base.html">pyg.base</a></li>
<li class="toctree-l1"><a class="reference internal" href="mongo.html">pyg.mongo</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeseries.html">pyg.timeseries</a></li>
<li class="toctree-l1"><a class="reference internal" href="base_tutorial.html">tutorial: pyg.base</a></li>
<li class="toctree-l1"><a class="reference internal" href="dictable_tutorial.html">tutorial: dictable</a></li>
<li class="toctree-l1"><a class="reference internal" href="dictable_tutorial.html#dictable-functionality">dictable functionality</a></li>
<li class="toctree-l1"><a class="reference internal" href="mongo_tutorial.html">tutorial: pyg.mongo</a></li>
<li class="toctree-l1"><a class="reference internal" href="timeseries_tutorial.html">tutorial: pyg.timeseries</a></li>
<li class="toctree-l1"><a class="reference internal" href="cell_tutorial.html">cell tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="cell_tutorial.html#now-let-us-do-the-same-but-with-cells-and-saving-the-data-to-mongodb">Now let us do the same but with cells and saving the data to MongoDB</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Yoav Git.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/cell_tutorial_old.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>